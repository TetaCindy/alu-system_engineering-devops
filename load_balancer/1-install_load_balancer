#!/usr/bin/env bash
# This script installs and configures HAProxy as a load balancer with round-robin distribution

# Update package list and install HAProxy
apt-get update
apt-get install -y haproxy

# Enable HAProxy to be started by init script
echo "ENABLED=1" > /etc/default/haproxy

# Create necessary directories
mkdir -p /run/haproxy
mkdir -p /var/lib/haproxy

# Backup original config if it exists
if [ -f /etc/haproxy/haproxy.cfg ]; then
    cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.backup
fi

# Stop any service using port 80 (like nginx)
service nginx stop 2>/dev/null || true

# Configure HAProxy
cat > /etc/haproxy/haproxy.cfg << 'EOF'
global
    log 127.0.0.1 local0
    log 127.0.0.1 local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

frontend http_front
    bind *:80
    stats uri /haproxy?stats
    default_backend http_back

backend http_back
    balance roundrobin
    server web-01 WEB_01_IP:80 check
    server web-02 WEB_02_IP:80 check
EOF

# Set web server IP addresses
WEB_01_IP="3.87.225.168"
WEB_02_IP="54.91.147.29"

# Replace placeholders with actual IPs
sed -i "s/WEB_01_IP/$WEB_01_IP/g" /etc/haproxy/haproxy.cfg
sed -i "s/WEB_02_IP/$WEB_02_IP/g" /etc/haproxy/haproxy.cfg

# Restart HAProxy to apply configuration
service haproxy restart

# Verify HAProxy is running
service haproxy status
