#!/usr/bin/env bash
# Configures HAProxy to load balance HTTP traffic across two backend servers using roundrobin, managed by an init script.

set -e

ID="[STUDENT_ID]"
HOST1="${ID}-web-01"
HOST2="${ID}-web-02"

# Install HAProxy
apt-get update -y
apt-get install -y haproxy

# Enable HAProxy via init script (for both systemd and sysvinit compatibility)
if grep -q '^ENABLED=' /etc/default/haproxy; then
    sed -i 's/^ENABLED=.*/ENABLED=1/' /etc/default/haproxy
else
    echo "ENABLED=1" >> /etc/default/haproxy
fi

systemctl enable haproxy

# (Optional) Uncomment below and set actual IPs if DNS does not resolve the hostnames correctly
# echo "10.0.0.2 $HOST1" >> /etc/hosts
# echo "10.0.0.3 $HOST2" >> /etc/hosts

# Configure haproxy
cat > /etc/haproxy/haproxy.cfg <<EOF
global
    log /dev/log    local0
    log /dev/log    local1 notice
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend lb_http
    bind *:80
    default_backend lb_back

backend lb_back
    balance roundrobin
    server srv1 $HOST1:80 check
    server srv2 $HOST2:80 check
EOF

systemctl restart haproxy

exit 0

